import os
import logging
import sqlite3
import re
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from contextlib import contextmanager
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token="BOT_TOKEN")  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω
dp = Dispatcher()

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
if os.path.exists('students.db'):
    os.remove('students.db')

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite
class DatabaseManager:
    def __init__(self, db_path='students.db'):
        self.db_path = db_path
        self._initialize_database()

    @contextmanager
    def _get_cursor(self):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        try:
            yield cursor
        finally:
            conn.commit()
            conn.close()

    def _initialize_database(self):
        with self._get_cursor() as cursor:
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS groups (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL UNIQUE,
                    course INTEGER NOT NULL
                )
            ''')
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS students (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    telegram_profile TEXT,
                    phone_number TEXT,
                    vk_link TEXT,
                    group_id INTEGER,
                    FOREIGN KEY (group_id) REFERENCES groups(id)
                )
            ''')
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS contacts (
                    user_id INTEGER PRIMARY KEY,
                    phone_number TEXT NOT NULL
                )
            ''')

    def add_group(self, name, course):
        try:
            with self._get_cursor() as cursor:
                cursor.execute('INSERT INTO groups (name, course) VALUES (?, ?)', (name, course))
                logging.info(f"Group '{name}' added successfully.")
                return True, f"‚úÖ –ì—Ä—É–ø–ø–∞ '{name}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ –∫—É—Ä—Å {course}!"
        except sqlite3.IntegrityError:
            logging.warning(f"Group '{name}' already exists.")
            return False, f"üö´ –ì—Ä—É–ø–ø–∞ '{name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
        except Exception as e:
            logging.error(f"Error adding group '{name}': {e}")
            return False, f"üö´ –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã '{name}': {e}"

    def group_exists(self, name, course):
        with self._get_cursor() as cursor:
            cursor.execute('SELECT * FROM groups WHERE name=? AND course=?', (name, course))
            return cursor.fetchone() is not None

    def get_all_groups(self):
        with self._get_cursor() as cursor:
            cursor.execute('SELECT * FROM groups')
            return cursor.fetchall()

    def get_groups_by_course(self, course):
        with self._get_cursor() as cursor:
            cursor.execute('SELECT * FROM groups WHERE course=?', (course,))
            return cursor.fetchall()

    def delete_group(self, group_id):
        with self._get_cursor() as cursor:
            cursor.execute('DELETE FROM groups WHERE id=?', (group_id,))

    def add_student(self, name, telegram_profile=None, phone_number=None, vk_link=None, group_id=None):
        with self._get_cursor() as cursor:
            cursor.execute('''
                INSERT INTO students (name, telegram_profile, phone_number, vk_link, group_id)
                VALUES (?, ?, ?, ?, ?)
            ''', (name, telegram_profile, phone_number, vk_link, group_id))

    def student_exists(self, name, telegram_profile):
        with self._get_cursor() as cursor:
            cursor.execute('SELECT * FROM students WHERE name=? OR telegram_profile=?', (name, telegram_profile))
            return cursor.fetchone() is not None

    def get_all_students(self):
        with self._get_cursor() as cursor:
            cursor.execute('SELECT * FROM students')
            return cursor.fetchall()

    def get_students_by_group(self, group_id):
        with self._get_cursor() as cursor:
            cursor.execute('SELECT * FROM students WHERE group_id=?', (group_id,))
            return cursor.fetchall()

    def delete_student(self, student_id):
        with self._get_cursor() as cursor:
            cursor.execute('DELETE FROM students WHERE id=?', (student_id,))

    def delete_student_by_telegram(self, telegram_profile):
        with self._get_cursor() as cursor:
            cursor.execute('DELETE FROM students WHERE telegram_profile=?', (telegram_profile,))

    def has_contact(self, user_id):
        with self._get_cursor() as cursor:
            cursor.execute('SELECT * FROM contacts WHERE user_id=?', (user_id,))
            return cursor.fetchone() is not None

    def save_contact(self, user_id, phone_number):
        with self._get_cursor() as cursor:
            cursor.execute('INSERT OR IGNORE INTO contacts (user_id, phone_number) VALUES (?, ?)', (user_id, phone_number))

db = DatabaseManager()

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
class Form(StatesGroup):
    waiting_for_group_name = State()
    waiting_for_group_course = State()
    waiting_for_group_selection = State()  # –î–ª—è –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞
    waiting_for_group = State()  # –î–ª—è –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã
    waiting_for_name = State()
    waiting_for_telegram = State()
    waiting_for_phone = State()
    waiting_for_vk = State()

class AdminPanel(StatesGroup):
    managing_users = State()
    managing_groups = State()

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
def main_menu_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø—É")],
            [KeyboardButton(text="üë• –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—â–∏—Ö—Å—è")],
            [KeyboardButton(text="üí∏ –î–æ–Ω–∞—Ç")],
            [KeyboardButton(text="‚ùå –£–¥–∞–ª–∏—Ç—å –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å")]
        ],
        resize_keyboard=True
    )

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
def admin_panel_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏")],
            [KeyboardButton(text="üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏")],
            [KeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É")],
            [KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]
        ],
        resize_keyboard=True
    )

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
def admin_back_keyboard():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_panel")]
        ]
    )

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
def validate_and_format_phone_number(phone_number: str) -> str | None:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX –∏–ª–∏ None, –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ–≤–∞–ª–∏–¥–µ–Ω.
    """
    # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
    cleaned_number = re.sub(r"[^0-9]", "", phone_number)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –Ω–æ–º–µ—Ä–∞
    if len(cleaned_number) == 11:
        if cleaned_number.startswith("8"):
            # –ó–∞–º–µ–Ω—è–µ–º 8 –Ω–∞ +7
            return "+7" + cleaned_number[1:]
        elif cleaned_number.startswith("7"):
            return "+" + cleaned_number
    elif len(cleaned_number) == 10:
        # –î–æ–±–∞–≤–ª—è–µ–º +7 –¥–ª—è –Ω–æ–º–µ—Ä–æ–≤ –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
        return "+7" + cleaned_number

    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
    return None

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message(Command("start"))
async def start(message: types.Message):
    if not db.has_contact(message.from_user.id):
        keyboard = ReplyKeyboardMarkup(
            keyboard=[
                [KeyboardButton(text="üì≤ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç", request_contact=True)]
            ],
            resize_keyboard=True
        )
        await message.answer("üëã –ü—Ä–∏–≤–µ—Ç! –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç.", reply_markup=keyboard)
    else:
        await message.answer("üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —É—á–µ–±–Ω—É—é –≥—Ä—É–ø–ø—É.", reply_markup=main_menu_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
@dp.message(F.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
async def return_to_main_menu(message: types.Message, state: FSMContext):
    await state.clear()  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
    
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
@dp.message(F.contact)
async def process_contact(message: types.Message):
    if message.contact and message.contact.phone_number:
        db.save_contact(message.from_user.id, message.contact.phone_number)
        await message.answer("‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç!", reply_markup=main_menu_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /admin (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
ADMIN_ID = ID  # –í–∞—à ID –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

@dp.message(Command("admin"))
async def admin_panel(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.", reply_markup=main_menu_keyboard())
        return

    await message.answer("üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!", reply_markup=admin_panel_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É"
@dp.message(F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É")
async def add_group_start(message: types.Message, state: FSMContext):
    if message.from_user.id != ADMIN_ID:
        await message.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.", reply_markup=main_menu_keyboard())
        return

    await message.answer("üìù –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã:", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]],
        resize_keyboard=True
    ))
    await state.set_state(Form.waiting_for_group_name)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
@dp.message(Form.waiting_for_group_name)
async def process_group_name(message: types.Message, state: FSMContext):
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await state.clear()
        await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return

    group_name = message.text.strip()
    if not group_name:
        await message.answer("üö´ –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:")
        return

    if len(group_name) > 50:
        await message.answer("üö´ –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ ‚Äî 50 —Å–∏–º–≤–æ–ª–æ–≤.")
        return

    await state.update_data({"group_name": group_name})
    await message.answer("üìö –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫—É—Ä—Å–∞ (1-4):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]],
        resize_keyboard=True
    ))
    await state.set_state(Form.waiting_for_group_course)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∫—É—Ä—Å–∞
@dp.message(Form.waiting_for_group_course)
async def process_group_course(message: types.Message, state: FSMContext):
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await state.clear()
        await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return

    try:
        course = int(message.text)
        if course < 1 or course > 4:
            raise ValueError
    except ValueError:
        await message.answer("üö´ –ù–æ–º–µ—Ä –∫—É—Ä—Å–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    data = await state.get_data()
    group_name = data.get("group_name")
    if db.group_exists(group_name, course):
        await message.answer(f"üö´ –ì—Ä—É–ø–ø–∞ '{group_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –∫—É—Ä—Å–µ {course}.", reply_markup=main_menu_keyboard())
    else:
        success, message_text = db.add_group(group_name, course)
        await message.answer(message_text, reply_markup=admin_panel_keyboard())

    await state.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏"
@dp.message(F.text == "üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏")
async def manage_groups(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.", reply_markup=main_menu_keyboard())
        return

    groups = db.get_all_groups()
    if not groups:
        await message.answer("üì≠ –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –ø—É—Å—Ç.", reply_markup=admin_panel_keyboard())
        return

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø
    keyboard = InlineKeyboardMarkup(inline_keyboard=[])
    for group in groups:
        keyboard.inline_keyboard.append(
            [InlineKeyboardButton(text=f"‚ùå –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É: {group[1]} (–ö—É—Ä—Å {group[2]})", callback_data=f"confirm_delete_group_{group[0]}")]
        )
    keyboard.inline_keyboard.append([InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_panel")])

    await message.answer("üìã –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø:", reply_markup=keyboard)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"
@dp.message(F.text == "üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏")
async def manage_users(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.", reply_markup=main_menu_keyboard())
        return

    students = db.get_all_students()
    if not students:
        await message.answer("üì≠ –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—É—Å—Ç.", reply_markup=admin_panel_keyboard())
        return

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    keyboard = InlineKeyboardMarkup(inline_keyboard=[])
    for student in students:
        keyboard.inline_keyboard.append(
            [InlineKeyboardButton(text=f"‚ùå –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {student[1]}", callback_data=f"confirm_delete_student_{student[0]}")]
        )
    keyboard.inline_keyboard.append([InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_panel")])

    await message.answer("üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", reply_markup=keyboard)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
@dp.callback_query(F.data.startswith("confirm_delete_"))
async def confirm_delete(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.", show_alert=True)
        return

    data = callback.data
    if data.startswith("confirm_delete_group_"):
        group_id = int(data.split("_")[3])
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —É–¥–∞–ª–µ–Ω–∏—è
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text="‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"delete_group_{group_id}")],
                [InlineKeyboardButton(text="‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∞", callback_data="admin_panel")]
            ]
        )
        await callback.message.edit_text(f"‚ùì –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É —Å ID {group_id}?", reply_markup=keyboard)

    elif data.startswith("confirm_delete_student_"):
        student_id = int(data.split("_")[3])
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —É–¥–∞–ª–µ–Ω–∏—è
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text="‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"delete_student_{student_id}")],
                [InlineKeyboardButton(text="‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∞", callback_data="admin_panel")]
            ]
        )
        await callback.message.edit_text(f"‚ùì –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {student_id}?", reply_markup=keyboard)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
@dp.callback_query(F.data.startswith("delete_"))
async def delete_item(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.", show_alert=True)
        return

    data = callback.data
    if data.startswith("delete_group_"):
        group_id = int(data.split("_")[2])
        db.delete_group(group_id)
        await callback.answer(f"‚úÖ –ì—Ä—É–ø–ø–∞ —Å ID {group_id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.", show_alert=True)
        await callback.message.edit_text("‚úÖ –ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞.", reply_markup=admin_back_keyboard())

    elif data.startswith("delete_student_"):
        student_id = int(data.split("_")[2])
        db.delete_student(student_id)
        await callback.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {student_id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.", show_alert=True)
        await callback.message.edit_text("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω.", reply_markup=admin_back_keyboard())

    elif data == "admin_panel":
        await callback.message.edit_text("üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!", reply_markup=admin_panel_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø—É"
@dp.message(F.text == "üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –≤ –≥—Ä—É–ø–ø—É")
async def register(message: types.Message, state: FSMContext):
    if not db.has_contact(message.from_user.id):
        await message.answer("üö´ –í—ã –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç.")
        return

    course_keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="1 –∫—É—Ä—Å")],
            [KeyboardButton(text="2 –∫—É—Ä—Å")],
            [KeyboardButton(text="3 –∫—É—Ä—Å")],
            [KeyboardButton(text="4 –∫—É—Ä—Å")],
            [KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]
        ],
        resize_keyboard=True
    )
    await message.answer("üìö –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å:", reply_markup=course_keyboard)
    await state.set_state(Form.waiting_for_group_selection)  # –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞
@dp.message(Form.waiting_for_group_selection)
async def process_course_selection(message: types.Message, state: FSMContext):
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await state.clear()
        await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return

    try:
        course = int(message.text.split()[0])  # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∫—É—Ä—Å–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
    except (ValueError, IndexError):
        await message.answer("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä –∫—É—Ä—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞.")
        return

    groups = db.get_groups_by_course(course)
    if not groups:
        await message.answer(f"üö´ –ù–∞ –∫—É—Ä—Å–µ {course} –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø.", reply_markup=main_menu_keyboard())
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä –∫—É—Ä—Å–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data({"course": course})

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≥—Ä—É–ø–ø–∞–º–∏
    group_buttons = [[KeyboardButton(text=f"üìö –ì—Ä—É–ø–ø–∞ {group[1]}")] for group in groups]
    group_buttons.append([KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")])

    group_keyboard = ReplyKeyboardMarkup(
        keyboard=group_buttons,
        resize_keyboard=True
    )

    await message.answer(f"üìö –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –Ω–∞ –∫—É—Ä—Å–µ {course}:", reply_markup=group_keyboard)
    await state.set_state(Form.waiting_for_group)  # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã
@dp.message(Form.waiting_for_group)
async def process_group_selection(message: types.Message, state: FSMContext):
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await state.clear()
        await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    if not message.text.startswith("üìö –ì—Ä—É–ø–ø–∞ "):
        await message.answer("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞.")
        return

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    selected_group = message.text.replace("üìö –ì—Ä—É–ø–ø–∞ ", "").strip()

    # –ò—â–µ–º –≥—Ä—É–ø–ø—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    data = await state.get_data()
    course = data.get("course")
    groups = db.get_groups_by_course(course)
    group_id = None
    for group in groups:
        if group[1] == selected_group:  # group[1] ‚Äî —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
            group_id = group[0]  # group[0] ‚Äî —ç—Ç–æ ID –≥—Ä—É–ø–ø—ã
            break

    if group_id is None:
        await message.answer("üö´ –ù–µ–≤–µ—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≥—Ä—É–ø–ø—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data({"group_id": group_id})

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É ‚Äî –≤–≤–æ–¥—É –∏–º–µ–Ω–∏
    await message.answer("üë§ –í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è:", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]],
        resize_keyboard=True
    ))
    await state.set_state(Form.waiting_for_name)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –∏–º–µ–Ω–∏
@dp.message(Form.waiting_for_name)
async def process_name(message: types.Message, state: FSMContext):
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await state.clear()
        await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return

    name = message.text
    data = await state.get_data()
    group_id = data.get("group_id")
    await state.set_state(Form.waiting_for_telegram)
    await message.answer(f"üë§ –û—Ç–ª–∏—á–Ω–æ, {name}! –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram-–ø—Ä–æ—Ñ–∏–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, @username):", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]],
        resize_keyboard=True
    ))
    await state.update_data({"name": name, "group_id": group_id})

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è Telegram-–ø—Ä–æ—Ñ–∏–ª—è
@dp.message(Form.waiting_for_telegram)
async def process_telegram(message: types.Message, state: FSMContext):
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await state.clear()
        await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return

    telegram_profile = message.text
    if not telegram_profile.startswith("@"):
        await message.answer("üö´ Telegram-–ø—Ä–æ—Ñ–∏–ª—å –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Å–∏–º–≤–æ–ª–∞ @. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    data = await state.get_data()
    name = data.get("name", "")
    group_id = data.get("group_id")
    await state.set_state(Form.waiting_for_phone)
    await message.answer(f"üì± –°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]],
        resize_keyboard=True
    ))
    await state.update_data({"name": name, "telegram_profile": telegram_profile, "group_id": group_id})

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
@dp.message(Form.waiting_for_phone)
async def process_phone(message: types.Message, state: FSMContext):
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await state.clear()
        await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return

    phone_number = message.text
    formatted_number = validate_and_format_phone_number(phone_number)
    if not formatted_number:
        await message.answer("üö´ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ: +7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    data = await state.get_data()
    name = data.get("name", "")
    telegram_profile = data.get("telegram_profile", "")
    group_id = data.get("group_id")
    await state.set_state(Form.waiting_for_vk)
    await message.answer(f"üåê –•–æ—Ä–æ—à–æ! –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –í–ö–æ–Ω—Ç–∞–∫—Ç–µ:", reply_markup=ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]],
        resize_keyboard=True
    ))
    await state.update_data({"name": name, "telegram_profile": telegram_profile, "phone_number": formatted_number, "group_id": group_id})

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –í–ö
@dp.message(Form.waiting_for_vk)
async def process_vk(message: types.Message, state: FSMContext):
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await state.clear()
        await message.answer("üè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=main_menu_keyboard())
        return

    vk_link = message.text
    if not re.match(r"^(https?://)?(www\.)?vk\.com/[\w\.-]+$", vk_link):
        await message.answer("üö´ –°—Å—ã–ª–∫–∞ –Ω–∞ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ: https://vk.com/username. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    data = await state.get_data()
    name = data.get("name", "")
    telegram_profile = data.get("telegram_profile", "")
    phone_number = data.get("phone_number", "")
    group_id = data.get("group_id")

    if db.student_exists(name, telegram_profile):
        await message.answer(f"üö´ –°—Ç—É–¥–µ–Ω—Ç —Å –∏–º–µ–Ω–µ–º '{name}' –∏–ª–∏ Telegram-–ø—Ä–æ—Ñ–∏–ª–µ–º '{telegram_profile}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.", reply_markup=main_menu_keyboard())
    else:
        db.add_student(name, telegram_profile, phone_number, vk_link, group_id)
        await message.answer("‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –≥—Ä—É–ø–ø—É!", reply_markup=main_menu_keyboard())

    await state.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—â–∏—Ö—Å—è"
@dp.message(F.text == "üë• –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—â–∏—Ö—Å—è")
async def view_students(message: types.Message):
    if not db.has_contact(message.from_user.id):
        await message.answer("üö´ –í—ã –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç.")
        return

    course_keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="1 –∫—É—Ä—Å")],
            [KeyboardButton(text="2 –∫—É—Ä—Å")],
            [KeyboardButton(text="3 –∫—É—Ä—Å")],
            [KeyboardButton(text="4 –∫—É—Ä—Å")],
            [KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]
        ],
        resize_keyboard=True
    )
    await message.answer("üìö –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ —É—á–∞—â–∏—Ö—Å—è:", reply_markup=course_keyboard)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ —É—á–∞—â–∏—Ö—Å—è
@dp.message(F.text.endswith("–∫—É—Ä—Å"))
async def view_students_by_course(message: types.Message):
    try:
        course = int(message.text.split()[0])
    except (ValueError, IndexError):
        await message.answer("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä –∫—É—Ä—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞.")
        return

    groups = db.get_groups_by_course(course)
    if not groups:
        await message.answer(f"üì≠ –ù–∞ –∫—É—Ä—Å–µ {course} –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø.", reply_markup=main_menu_keyboard())
        return

    response = f"üìã –°–ø–∏—Å–æ–∫ —É—á–∞—â–∏—Ö—Å—è –Ω–∞ –∫—É—Ä—Å–µ {course}:\n\n"
    for group in groups:
        students = db.get_students_by_group(group[0])
        if students:
            response += f"üìö –ì—Ä—É–ø–ø–∞ {group[1]}:\n"
            for student in students:
                response += (
                    f"üë§ –ò–º—è: {student[1]}\n"
                    f"üì± Telegram: {student[2]}\n"
                    f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {student[3]}\n"
                    f"üåê –í–ö–æ–Ω—Ç–∞–∫—Ç–µ: {student[4]}\n\n"
                )
        else:
            response += f"üìö –ì—Ä—É–ø–ø–∞ {group[1]}: –ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—â–∏—Ö—Å—è.\n\n"

    await message.answer(response, reply_markup=main_menu_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å"
@dp.message(F.text == "‚ùå –£–¥–∞–ª–∏—Ç—å –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å")
async def delete_profile(message: types.Message):
    if not db.has_contact(message.from_user.id):
        await message.answer("üö´ –í—ã –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç.")
        return

    db.delete_student_by_telegram(message.from_user.username)
    await message.answer("‚úÖ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.", reply_markup=main_menu_keyboard())

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–î–æ–Ω–∞—Ç"
@dp.message(F.text == "üí∏ –î–æ–Ω–∞—Ç")
async def donate(message: types.Message):
    if not db.has_contact(message.from_user.id):
        await message.answer("üö´ –í—ã –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç. –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç.")
        return

    donate_button = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üí∏ –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç", url="https://yoomoney.ru/to/4100118763269949")]
        ]
    )
    await message.answer("üíñ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞!", reply_markup=donate_button)

if __name__ == '__main__':
    dp.run_polling(bot)
